<HTML>

<HEAD>
    <script src="v.js"></script>
    <script src="MidiProcessor.js"></script>
    <style>

    </style>
    <title>Dashboard</title>
    BPM = <input id="tarBpm" type="number" value="60"></input>
    DIFF = <input id="tarDiff" type="number" value="16"></input>
    <div id="chartContainer" style="height: 370px; width:100%;"></div>
    <center><span id="txtDebug"></span></center>
    <script src="https://canvasjs.com/assets/script/canvasjs.min.js"></script>
</HEAD>

<BODY>

</BODY>
<script>
    var tarBpm = parseInt(document.getElementById("tarBpm").value);
    document.getElementById("tarBpm").addEventListener("change", () => {
        tarBpm = parseInt(document.getElementById("tarBpm").value);
        tarIntv = 60000 / tarBpm;
    });

    var DIFF = 1 / parseInt(document.getElementById("tarDiff").value);
    document.getElementById("tarDiff").addEventListener("change", () => {
        DIFF = 1 / parseInt(document.getElementById("tarDiff").value);
    });

    var midi = new MidiProcessor();
    var v = new Visualizer(show);
    function init() {
        midi.init(v);
    }


    var bpms = new Array(); // dataPoints
    var xVal = 0;
    for (var i = 0; i < 60; i++) {
        bpms.push({ x: xVal++, y: tarBpm });
    }

    var chart = new CanvasJS.Chart("chartContainer", {
        title: {
            text: "BPM"
        },
        data: [{
            type: "line",
            dataPoints: bpms
        }]
    });

    function show(note) {
        var bpm = bpmCalc(note.duration);
        if (bpm > 0) {
            bpms.push({ x: xVal++, y: bpm });
            bpms.shift();
            chart.render();
        }
    }

    function bpmCalc(duration) {
        var bpm = tarBpm;
        while (bpm > 0 && bpm < 1000) {
            var tarIntv = 60000 / bpm;
            var diff = tarIntv * DIFF;
            var min = parseInt(tarIntv - diff);
            var max = parseInt(tarIntv + diff);
            document.getElementById("txtDebug").innerText = bpm + "+-" + parseInt(diff) + " [" + min + "," + max + "] " + duration;
            if (duration < min) {
                bpm++;
            } else if (duration > max) {
                bpm--;
            } else {
                return bpm;
            }
        }
        return -1;
    }

    document.addEventListener("DOMContentLoaded", () => {
        init();
    });

</script>

</HTML>